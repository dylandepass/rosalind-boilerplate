import{s as u}from"./index-d475d2ea.js";import{M as U}from"./index-a6c8ef6f.js";import"./_commonjsHelpers-042e6b4d.js";const{addons:L}=__STORYBOOK_MODULE_PREVIEW_API__,{once:M,logger:P}=__STORYBOOK_MODULE_CLIENT_LOGGER__,{FORCE_REMOUNT:y,IGNORED_EXCEPTION:k,SET_CURRENT_STORY:B,STORY_RENDER_PHASE_CHANGED:Y}=__STORYBOOK_MODULE_CORE_EVENTS__;var x=(e=>(e.DONE="done",e.ERROR="error",e.ACTIVE="active",e.WAITING="waiting",e))(x||{}),f={CALL:"storybook/instrumenter/call",SYNC:"storybook/instrumenter/sync",START:"storybook/instrumenter/start",BACK:"storybook/instrumenter/back",GOTO:"storybook/instrumenter/goto",NEXT:"storybook/instrumenter/next",END:"storybook/instrumenter/end"},C=u.FEATURES?.interactionsDebugger!==!0,T={debugger:!C,start:!1,back:!1,goto:!1,next:!1,end:!1},b=new Error("This function ran after the play function completed. Did you forget to `await` it?"),w=e=>Object.prototype.toString.call(e)==="[object Object]",K=e=>Object.prototype.toString.call(e)==="[object Module]",G=e=>{if(!w(e)&&!K(e))return!1;if(e.constructor===void 0)return!0;let t=e.constructor.prototype;return!(!w(t)||Object.prototype.hasOwnProperty.call(t,"isPrototypeOf")===!1)},F=e=>{try{return new e.constructor}catch{return{}}},S=()=>({renderPhase:void 0,isDebugging:!1,isPlaying:!1,isLocked:!1,cursor:0,calls:[],shadowCalls:[],callRefsByResult:new Map,chainedCallIds:new Set,ancestors:[],playUntil:void 0,resolvers:{},syncTimeout:void 0}),I=(e,t=!1)=>{let c=(t?e.shadowCalls:e.calls).filter(r=>r.retain);if(!c.length)return;let o=new Map(Array.from(e.callRefsByResult.entries()).filter(([,r])=>r.retain));return{cursor:c.length,calls:c,callRefsByResult:o}},V=class{constructor(){this.initialized=!1,this.channel=L.getChannel(),this.state=u.window.parent.__STORYBOOK_ADDON_INTERACTIONS_INSTRUMENTER_STATE__||{};let e=({storyId:n,isPlaying:a=!0,isDebugging:s=!1})=>{let i=this.getState(n);this.setState(n,{...S(),...I(i,s),shadowCalls:s?i.shadowCalls:[],chainedCallIds:s?i.chainedCallIds:new Set,playUntil:s?i.playUntil:void 0,isPlaying:a,isDebugging:s}),this.sync(n)};this.channel.on(y,e),this.channel.on(Y,({storyId:n,newPhase:a})=>{let{isDebugging:s}=this.getState(n);this.setState(n,{renderPhase:a}),a==="preparing"&&s&&e({storyId:n}),a==="playing"&&e({storyId:n,isDebugging:s}),a==="played"&&this.setState(n,{isLocked:!1,isPlaying:!1,isDebugging:!1}),a==="errored"&&this.setState(n,{isLocked:!1,isPlaying:!1})}),this.channel.on(B,()=>{this.initialized?this.cleanup():this.initialized=!0});let t=({storyId:n,playUntil:a})=>{this.getState(n).isDebugging||this.setState(n,({calls:i})=>({calls:[],shadowCalls:i.map(_=>({..._,status:"waiting"})),isDebugging:!0}));let s=this.getLog(n);this.setState(n,({shadowCalls:i})=>{if(a||!s.length)return{playUntil:a};let _=i.findIndex(h=>h.id===s[0].callId);return{playUntil:i.slice(0,_).filter(h=>h.interceptable&&!h.ancestors.length).slice(-1)[0]?.id}}),this.channel.emit(y,{storyId:n,isDebugging:!0})},c=({storyId:n})=>{let a=this.getLog(n).filter(i=>!i.ancestors.length),s=a.reduceRight((i,_,h)=>i>=0||_.status==="waiting"?i:h,-1);t({storyId:n,playUntil:a[s-1]?.callId})},o=({storyId:n,callId:a})=>{let{calls:s,shadowCalls:i,resolvers:_}=this.getState(n),h=s.find(({id:d})=>d===a),g=i.find(({id:d})=>d===a);if(!h&&g&&Object.values(_).length>0){let d=this.getLog(n).find(O=>O.status==="waiting")?.callId;g.id!==d&&this.setState(n,{playUntil:g.id}),Object.values(_).forEach(O=>O())}else t({storyId:n,playUntil:a})},r=({storyId:n})=>{let{resolvers:a}=this.getState(n);if(Object.values(a).length>0)Object.values(a).forEach(s=>s());else{let s=this.getLog(n).find(i=>i.status==="waiting")?.callId;s?t({storyId:n,playUntil:s}):l({storyId:n})}},l=({storyId:n})=>{this.setState(n,{playUntil:void 0,isDebugging:!1}),Object.values(this.getState(n).resolvers).forEach(a=>a())};this.channel.on(f.START,t),this.channel.on(f.BACK,c),this.channel.on(f.GOTO,o),this.channel.on(f.NEXT,r),this.channel.on(f.END,l)}getState(e){return this.state[e]||S()}setState(e,t){let c=this.getState(e),o=typeof t=="function"?t(c):t;this.state={...this.state,[e]:{...c,...o}},u.window.parent.__STORYBOOK_ADDON_INTERACTIONS_INSTRUMENTER_STATE__=this.state}cleanup(){this.state=Object.entries(this.state).reduce((t,[c,o])=>{let r=I(o);return r&&(t[c]=Object.assign(S(),r)),t},{});let e={controlStates:T,logItems:[]};this.channel.emit(f.SYNC,e),u.window.parent.__STORYBOOK_ADDON_INTERACTIONS_INSTRUMENTER_STATE__=this.state}getLog(e){let{calls:t,shadowCalls:c}=this.getState(e),o=[...c];t.forEach((l,n)=>{o[n]=l});let r=new Set;return o.reduceRight((l,n)=>(n.args.forEach(a=>{a?.__callId__&&r.add(a.__callId__)}),n.path.forEach(a=>{a.__callId__&&r.add(a.__callId__)}),(n.interceptable||n.exception)&&!r.has(n.id)&&(l.unshift({callId:n.id,status:n.status,ancestors:n.ancestors}),r.add(n.id)),l),[])}instrument(e,t){if(!G(e))return e;let{mutate:c=!1,path:o=[]}=t;return Object.keys(e).reduce((r,l)=>{let n=e[l];return typeof n!="function"?(r[l]=this.instrument(n,{...t,path:o.concat(l)}),r):typeof n.__originalFn__=="function"?(r[l]=n,r):(r[l]=(...a)=>this.track(l,n,a,t),r[l].__originalFn__=n,Object.defineProperty(r[l],"name",{value:l,writable:!1}),Object.keys(n).length>0&&Object.assign(r[l],this.instrument({...n},{...t,path:o.concat(l)})),r)},c?e:F(e))}track(e,t,c,o){let r=c?.[0]?.__storyId__||u.__STORYBOOK_PREVIEW__?.selectionStore?.selection?.storyId,{cursor:l,ancestors:n}=this.getState(r);this.setState(r,{cursor:l+1});let a=`${n.slice(-1)[0]||r} [${l}] ${e}`,{path:s=[],intercept:i=!1,retain:_=!1}=o,h=typeof i=="function"?i(e,s):i,g={id:a,cursor:l,storyId:r,ancestors:n,path:s,method:e,args:c,interceptable:h,retain:_},d=(h&&!n.length?this.intercept:this.invoke).call(this,t,g,o);return this.instrument(d,{...o,mutate:!0,path:[{__callId__:g.id}]})}intercept(e,t,c){let{chainedCallIds:o,isDebugging:r,playUntil:l}=this.getState(t.storyId),n=o.has(t.id);return!r||n||l?(l===t.id&&this.setState(t.storyId,{playUntil:void 0}),this.invoke(e,t,c)):new Promise(a=>{this.setState(t.storyId,({resolvers:s})=>({isLocked:!1,resolvers:{...s,[t.id]:a}}))}).then(()=>(this.setState(t.storyId,a=>{let{[t.id]:s,...i}=a.resolvers;return{isLocked:!0,resolvers:i}}),this.invoke(e,t,c)))}invoke(e,t,c){let{callRefsByResult:o,renderPhase:r}=this.getState(t.storyId),l=s=>{if(o.has(s))return o.get(s);if(s instanceof Array)return s.map(l);if(s instanceof Date)return{__date__:{value:s.toISOString()}};if(s instanceof Error){let{name:i,message:_,stack:h}=s;return{__error__:{name:i,message:_,stack:h}}}if(s instanceof RegExp){let{flags:i,source:_}=s;return{__regexp__:{flags:i,source:_}}}if(s instanceof u.window.HTMLElement){let{prefix:i,localName:_,id:h,classList:g,innerText:d}=s,O=Array.from(g);return{__element__:{prefix:i,localName:_,id:h,classNames:O,innerText:d}}}return typeof s=="function"?{__function__:{name:s.name}}:typeof s=="symbol"?{__symbol__:{description:s.description}}:typeof s=="object"&&s?.constructor?.name&&s?.constructor?.name!=="Object"?{__class__:{name:s.constructor.name}}:Object.prototype.toString.call(s)==="[object Object]"?Object.fromEntries(Object.entries(s).map(([i,_])=>[i,l(_)])):s},n={...t,args:t.args.map(l)};t.path.forEach(s=>{s?.__callId__&&this.setState(t.storyId,({chainedCallIds:i})=>({chainedCallIds:new Set(Array.from(i).concat(s.__callId__))}))});let a=s=>{if(s instanceof Error){let{name:i,message:_,stack:h,callId:g=t.id}=s,d={name:i,message:_,stack:h,callId:g};if(this.update({...n,status:"error",exception:d}),this.setState(t.storyId,O=>({callRefsByResult:new Map([...Array.from(O.callRefsByResult.entries()),[s,{__callId__:t.id,retain:t.retain}]])})),t.ancestors.length)throw Object.prototype.hasOwnProperty.call(s,"callId")||Object.defineProperty(s,"callId",{value:t.id}),s;if(s!==b)throw P.warn(s),k}throw s};try{if(r==="played"&&!t.retain)throw b;let s=(c.getArgs?c.getArgs(t,this.getState(t.storyId)):t.args).map(_=>typeof _!="function"||Object.keys(_).length?_:(...h)=>{let{cursor:g,ancestors:d}=this.getState(t.storyId);this.setState(t.storyId,{cursor:0,ancestors:[...d,t.id]});let O=()=>this.setState(t.storyId,{cursor:g,ancestors:d}),m=!1;try{let p=_(...h);return p instanceof Promise?(m=!0,p.finally(O)):p}finally{m||O()}}),i=e(...s);return i&&["object","function","symbol"].includes(typeof i)&&this.setState(t.storyId,_=>({callRefsByResult:new Map([...Array.from(_.callRefsByResult.entries()),[i,{__callId__:t.id,retain:t.retain}]])})),this.update({...n,status:i instanceof Promise?"active":"done"}),i instanceof Promise?i.then(_=>(this.update({...n,status:"done"}),_),a):i}catch(s){return a(s)}}update(e){this.channel.emit(f.CALL,e),this.setState(e.storyId,({calls:t})=>{let c=t.concat(e).reduce((o,r)=>Object.assign(o,{[r.id]:r}),{});return{calls:Object.values(c).sort((o,r)=>o.id.localeCompare(r.id,void 0,{numeric:!0}))}}),this.sync(e.storyId)}sync(e){let t=()=>{let{isLocked:c,isPlaying:o}=this.getState(e),r=this.getLog(e),l=r.filter(({ancestors:i})=>!i.length).find(i=>i.status==="waiting")?.callId,n=r.some(i=>i.status==="active");if(C||c||n||r.length===0){let i={controlStates:T,logItems:r};this.channel.emit(f.SYNC,i);return}let a=r.some(i=>["done","error"].includes(i.status)),s={controlStates:{debugger:!0,start:a,back:a,goto:!0,next:o,end:o},logItems:r,pausedAt:l};this.channel.emit(f.SYNC,s)};this.setState(e,({syncTimeout:c})=>(clearTimeout(c),{syncTimeout:setTimeout(t,0)}))}};function D(e,t={}){try{let c=!1,o=!1;return u.window.location?.search?.includes("instrument=true")?c=!0:u.window.location?.search?.includes("instrument=false")&&(o=!0),u.window.parent===u.window&&!c||o?e:(u.window.__STORYBOOK_ADDON_INTERACTIONS_INSTRUMENTER__||(u.window.__STORYBOOK_ADDON_INTERACTIONS_INSTRUMENTER__=new V),u.window.__STORYBOOK_ADDON_INTERACTIONS_INSTRUMENTER__.instrument(e,t))}catch(c){return M.warn(c),e}}const{addons:$}=__STORYBOOK_MODULE_PREVIEW_API__,{FORCE_REMOUNT:H,STORY_RENDER_PHASE_CHANGED:v}=__STORYBOOK_MODULE_CORE_EVENTS__;var N=new U(global),z=N.fn.bind(N),{action:W}=D({action:z},{retain:!0}),j=$.getChannel(),A=new Set,R=[];j.on(H,()=>R.forEach(e=>e?.mockClear?.()));j.on(v,({newPhase:e})=>{e==="loading"&&R.forEach(t=>t?.mockClear?.())});var E=(e,t,c)=>{if(A.has(t))return t;A.add(t);try{if(Object.prototype.toString.call(t)==="[object Object]"){for(let[o,r]of Object.entries(t))t[o]=E(e,r,o);return t}if(Array.isArray(t))return t.map((o,r)=>E(e,o,`${c}[${r}]`));if(typeof t=="function"&&t.isAction){Object.defineProperty(t,"name",{value:c,writable:!1}),Object.defineProperty(t,"__storyId__",{value:e,writable:!1});let o=W(t);return R.push(o),o}}catch{}return t},X=({id:e,initialArgs:t})=>E(e,t),Z=[X],{step:tt}=D({step:(e,t,c)=>t(c)},{intercept:!0}),et={throwPlayFunctionExceptions:!1};export{Z as argsEnhancers,et as parameters,tt as runStep};
//# sourceMappingURL=preview-65312421.js.map
